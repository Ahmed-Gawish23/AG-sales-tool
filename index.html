<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.G Sales Filter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        header, footer {
            text-align: center;
            padding: 10px;
            background-color: #007bff;
            color: white;
        }
        footer {
            background-color: #343a40;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <header>
        <h1>A.G Sales Filter</h1>
    </header>
    <div class="container">
        <p>Upload your Excel file, select your territory and product name, and view your sales data.</p>
        <input type="file" id="upload" accept=".xlsx, .xls" />
        <br><br>
        
        <label for="territory">Select Territory:</label>
        <select id="territory" class="select2" multiple="multiple" style="width: 100%;" placeholder="Select Territory"></select>
        <br><br>
        
        <label for="product">Select Product:</label>
        <select id="product" class="select2" multiple="multiple" style="width: 100%;" placeholder="Select Product"></select>
        <br><br>
        
        <button onclick="filterData()">Filter Data</button>
        <table id="results"></table>
    </div>
    <footer>
        Designed by Ahmed Gawish
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            $(".select2").select2();

            const distributorColumns = {
                PharmaOverseas: { territory: "Territory Name", product: "Product Name", qty: "Sales" },
                Ibnsina: { territory: "Territory Name", product: "Item Name", qty: "QTY" },
                "ABOU KIR": { territory: "ZONE_NAME", product: "PRODUCT_NAME", qty: "NET_QUANTITY" },
            };

            let sheetData = [];
            let selectedDistributor = "";

            document.getElementById("upload").addEventListener("change", (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    const workbook = XLSX.read(event.target.result, { type: "binary" });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    console.log("Raw Rows:", rows);

                    selectedDistributor = detectDistributor(rows);
                    console.log("Detected Distributor:", selectedDistributor);
                    const distributorConfig = distributorColumns[selectedDistributor];

                    if (!distributorConfig) {
                        alert("Distributor type not recognized.");
                        return;
                    }

                    const { territory, product, qty } = distributorConfig;
                    const headerRow = rows[0];

                    const territoryIndex = headerRow.indexOf(territory);
                    const productIndex = headerRow.indexOf(product);
                    const qtyIndex = headerRow.indexOf(qty);

                    console.log("Header Row:", headerRow);
                    console.log("Column Indices - Territory:", territoryIndex, "Product:", productIndex, "Quantity:", qtyIndex);

                    if (territoryIndex === -1 || productIndex === -1 || qtyIndex === -1) {
                        alert("Required columns not found. Please check your file.");
                        return;
                    }

                    sheetData = rows.slice(1).map((row) => ({
                        territory: row[territoryIndex],
                        product: row[productIndex],
                        qty: row[qtyIndex],
                    }));

                    console.log("Extracted Sheet Data:", sheetData);
                    populateDropdowns(sheetData);
                };
                reader.readAsBinaryString(file);
            });

            function detectDistributor(rows) {
                const header = rows[0].join(" ");
                if (header.includes("Territory Name") && header.includes("Product Name")) return "PharmaOverseas";
                if (header.includes("Territory Name") && header.includes("Item Name")) return "Ibnsina";
                if (header.includes("ZONE_NAME")) return "ABOU KIR";
                return "";
            }

            function populateDropdowns(data) {
                const territories = [...new Set(data.map((item) => item.territory))].filter(Boolean).sort();
                const products = [...new Set(data.map((item) => item.product))].filter(Boolean).sort();

                console.log("Unique Territories:", territories);
                console.log("Unique Products:", products);

                $("#territory").empty().append(territories.map((t) => `<option>${t}</option>`));
                $("#product").empty().append(products.map((p) => `<option>${p}</option>`));
            }

            window.filterData = () => {
                const selectedTerritories = $("#territory").val();
                const selectedProducts = $("#product").val();

                const filtered = sheetData.filter(
                    (row) =>
                        selectedTerritories.includes(row.territory) &&
                        selectedProducts.includes(row.product)
                );

                displayResults(filtered);
            };

            function displayResults(data) {
                const table = document.getElementById("results");
                table.innerHTML = `
                    <tr>
                        <th>Territory</th>
                        <th>Product</th>
                        <th>Quantity</th>
                    </tr>
                `;
                data.forEach((row) => {
                    table.innerHTML += `
                        <tr>
                            <td>${row.territory || "N/A"}</td>
                            <td>${row.product || "N/A"}</td>
                            <td>${row.qty || 0}</td>
                        </tr>
                    `;
                });
            }
        });
    </script>
</body>
</html>